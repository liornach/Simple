<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Dough Recipe - Dough Calculator</title>
  <link rel="stylesheet" href="../css/styles.css">
  <script type="module" src="../components/web-components/navigation-component.js"></script>
</head>
<body>
  <navigation-component></navigation-component>
  
  <main class="container">
    <div class="card">
      <h1 data-i18n="addDough">Add Dough Recipe</h1>
      
      <form id="doughForm">
        <div class="form-group">
          <label for="recipeName" data-i18n="recipeName">Recipe Name</label>
          <input type="text" id="recipeName" required>
        </div>
        
        <div class="ingredient-section">
          <div class="section-title" data-i18n="flours">Flours</div>
          <div id="floursContainer">
            <!-- Flour ingredients will be added here -->
            <div class="ingredient-item">
              <div class="form-group">
                <label for="flourName" data-i18n="name">Name</label>
                <input type="text" id="flourName" placeholder="e.g., Bread Flour">
              </div>
              <div class="form-group">
                <label for="flourPercentage" data-i18n="percentage">Percentage (%)</label>
                <input type="number" id="flourPercentage" min="0" step="0.1" placeholder="e.g., 100">
              </div>
              <button type="button" id="addFlourBtn" class="add-btn">+</button>
            </div>
          </div>
        </div>
        
        <div class="ingredient-section">
          <div class="section-title" data-i18n="otherIngredients">Other Ingredients</div>
          <div id="ingredientsContainer">
            <!-- Other ingredients will be added here -->
            <div class="ingredient-item">
              <div class="form-group">
                <label for="ingredientName" data-i18n="name">Name</label>
                <input type="text" id="ingredientName" placeholder="e.g., Water">
              </div>
              <div class="form-group">
                <label for="ingredientPercentage" data-i18n="percentage">Percentage (%)</label>
                <input type="number" id="ingredientPercentage" min="0" step="0.1" placeholder="e.g., 70">
              </div>
              <button type="button" id="addIngredientBtn" class="add-btn">+</button>
            </div>
          </div>
        </div>
        
        <button type="submit" data-i18n="submit">Submit</button>
      </form>
    </div>
  </main>

  <script type="module">
    import { setLanguage, currentLanguage, requireAuth, apiRequest } from '../js/utils.js';
    
    // Set initial language
    document.addEventListener('DOMContentLoaded', async () => {
      setLanguage(currentLanguage);
      
      // Check if user is logged in
      const isAuth = await requireAuth();
      if (!isAuth) return;
      
      // Check if editing existing recipe
      const urlParams = new URLSearchParams(window.location.search);
      const recipeId = urlParams.get('id');
      
      if (recipeId) {
        loadRecipe(recipeId);
      }
      
      // Add event listeners
      setupEventListeners();
      
      // Language change event
      window.addEventListener('languageChanged', () => {
        setLanguage(currentLanguage);
      });
    });
    
    // Recipe data
    const recipeData = {
      id: null,
      name: '',
      flours: [],
      ingredients: []
    };
    
    function setupEventListeners() {
      // Add flour button
      document.getElementById('addFlourBtn').addEventListener('click', () => {
        addIngredient('flour');
      });
      
      // Add ingredient button
      document.getElementById('addIngredientBtn').addEventListener('click', () => {
        addIngredient('ingredient');
      });
      
      // Form submission
      document.getElementById('doughForm').addEventListener('submit', (e) => {
        e.preventDefault();
        saveRecipe();
      });
    }
    
    function addIngredient(type) {
      const nameInput = document.getElementById(type === 'flour' ? 'flourName' : 'ingredientName');
      const percentageInput = document.getElementById(type === 'flour' ? 'flourPercentage' : 'ingredientPercentage');
      
      const name = nameInput.value.trim();
      const percentage = parseFloat(percentageInput.value);
      
      if (!name || isNaN(percentage)) {
        alert('Please enter both name and percentage');
        return;
      }
      
      // Add to recipe data
      if (type === 'flour') {
        recipeData.flours.push({ name, percentage, is_flour: true });
      } else {
        recipeData.ingredients.push({ name, percentage, is_flour: false });
      }
      
      // Clear inputs
      nameInput.value = '';
      percentageInput.value = '';
      
      // Update display
      updateIngredientsDisplay();
    }
    
    function updateIngredientsDisplay() {
      // Update flours display
      const floursContainer = document.getElementById('floursContainer');
      const flourInputRow = floursContainer.querySelector('.ingredient-item');
      
      // Clear existing items except the input row
      while (floursContainer.children.length > 1) {
        floursContainer.removeChild(floursContainer.children[0]);
      }
      
      // Add flour items
      recipeData.flours.forEach((flour, index) => {
        const item = document.createElement('div');
        item.className = 'ingredient-item';
        item.innerHTML = `
          <div class="ingredient-name">${flour.name}</div>
          <div class="ingredient-percentage">${flour.percentage}%</div>
          <button type="button" class="remove-btn" data-type="flour" data-index="${index}">×</button>
        `;
        
        floursContainer.insertBefore(item, flourInputRow);
      });
      
      // Update ingredients display
      const ingredientsContainer = document.getElementById('ingredientsContainer');
      const ingredientInputRow = ingredientsContainer.querySelector('.ingredient-item');
      
      // Clear existing items except the input row
      while (ingredientsContainer.children.length > 1) {
        ingredientsContainer.removeChild(ingredientsContainer.children[0]);
      }
      
      // Add ingredient items
      recipeData.ingredients.forEach((ingredient, index) => {
        const item = document.createElement('div');
        item.className = 'ingredient-item';
        item.innerHTML = `
          <div class="ingredient-name">${ingredient.name}</div>
          <div class="ingredient-percentage">${ingredient.percentage}%</div>
          <button type="button" class="remove-btn" data-type="ingredient" data-index="${index}">×</button>
        `;
        
        ingredientsContainer.insertBefore(item, ingredientInputRow);
      });
      
      // Add event listeners to remove buttons
      document.querySelectorAll('.remove-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const type = e.target.dataset.type;
          const index = parseInt(e.target.dataset.index);
          
          if (type === 'flour') {
            recipeData.flours.splice(index, 1);
          } else {
            recipeData.ingredients.splice(index, 1);
          }
          
          updateIngredientsDisplay();
        });
      });
    }
    
    async function loadRecipe(recipeId) {
      try {
        const recipe = await apiRequest(`/recipes/${recipeId}/`);
        
        // Set recipe data
        recipeData.id = recipe.id;
        recipeData.name = recipe.name;
        
        // Set recipe name in form
        document.getElementById('recipeName').value = recipe.name;
        
        // Set ingredients
        recipe.ingredients.forEach(ingredient => {
          if (ingredient.is_flour) {
            recipeData.flours.push(ingredient);
          } else {
            recipeData.ingredients.push(ingredient);
          }
        });
        
        // Update display
        updateIngredientsDisplay();
        
      } catch (error) {
        console.error('Error loading recipe:', error);
        alert('Failed to load recipe. Please try again.');
      }
    }
    
    async function saveRecipe() {
      const recipeName = document.getElementById('recipeName').value.trim();
      
      if (!recipeName) {
        alert('Please enter a recipe name');
        return;
      }
      
      if (recipeData.flours.length === 0) {
        alert('Please add at least one flour');
        return;
      }
      
      recipeData.name = recipeName;
      
      try {
        let recipe;
        
        if (recipeData.id) {
          // Update existing recipe
          recipe = await apiRequest(`/recipes/${recipeData.id}/`, 'PUT', {
            name: recipeData.name
          });
          
          // Delete existing ingredients
          const existingIngredients = await apiRequest(`/recipes/${recipeData.id}/ingredients/`);
          for (const ingredient of existingIngredients) {
            await apiRequest(`/ingredients/${ingredient.id}/`, 'DELETE');
          }
        } else {
          // Create new recipe
          recipe = await apiRequest('/recipes/', 'POST', {
            name: recipeData.name
          });
        }
        
        // Add ingredients
        const allIngredients = [...recipeData.flours, ...recipeData.ingredients];
        
        for (const ingredient of allIngredients) {
          await apiRequest(`/recipes/${recipe.id}/ingredients/`, 'POST', {
            name: ingredient.name,
            percentage: ingredient.percentage,
            is_flour: ingredient.is_flour
          });
        }
        
        alert('Recipe saved successfully!');
        window.location.href = '../index.html';
        
      } catch (error) {
        console.error('Error saving recipe:', error);
        alert('Failed to save recipe. Please try again.');
      }
    }
  </script>
</body>
</html>
